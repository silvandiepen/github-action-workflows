name: Conditional Environment Instance Variable


on:
  workflow_dispatch:
  push:
    branches: 
      - main

env:
  PROD_BRANCH: main
  STAGE_BRANCH: staging
  TEST_BRANCH: develop
  PROD_INSTANCE: prod
  STAGE_INSTANCE: stage
  TEST_INSTANCE: dev
    
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      instance: ${{ steps.set-variable.outputs.instance }}
    steps:
      - uses: actions/checkout@v2
      - name: Set Instance variable
        id: set-variable
        run: |
          if [ ${{ github.ref }} == 'refs/heads/${{ env.PROD_BRANCH }}' ]; then
            echo "::set-output name=instance::${{ env.PROD_INSTANCE }}"
          elif [ ${{ github.ref }} == 'refs/heads/${{ env.STAGE_BRANCH }}' ]; then
            echo "::set-output name=instance::${{ env.STAGE_INSTANCE }}"
          elif [ ${{ github.ref }} == 'refs/heads/${{ env.TEST_BRANCH }}' ]; then
            echo "::set-output name=instance::${{ env.TEST_INSTANCE }}"
          else
            echo "::set-output name=instance::${{ github.ref }}"
          fi
        shell: bash
      - name: Read exported variable
        run: |
          echo "OUTPUT: ${{ steps.set-variable.outputs.instance }}"
       
  build:
    runs-on: ubuntu-latest
    needs: [setup]
    steps:
      - uses: actions/checkout@v2
      - name: Read exported variable
        run: |
          echo "OUTPUT: ${{needs.setup.outputs.instance}}"
